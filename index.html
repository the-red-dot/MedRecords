<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>××¢×§×‘ × ×’×¢×™ ×¢×•×¨ â€“ ABCDE</title>
<style>
  :root{ --bg:#ffffff;--fg:#111;--muted:#666;--accent:#0a7cff;--card:#f6f7f9;--border:#e6e8eb }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;margin:0;background:var(--bg);color:var(--fg)}
  header{background:#fff;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  header .right{margin-inline-start:auto;display:flex;gap:8px;align-items:center}
  h1{margin:0;font-size:1.1rem}
  main{padding:16px;max-width:860px;margin:auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  label{font-weight:600;display:block;margin-top:8px}
  input,textarea,button,select{font-size:1rem}
  input[type="date"],input[type="text"],textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  textarea{min-height:80px;resize:vertical}
  .abcde-item{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px}
  .abcde-options{display:flex;gap:14px;flex-wrap:wrap;margin-top:6px}
  .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;font-weight:700}
  button.secondary{background:#e9eefb;color:#0a2a5f}
  .tiny{font-size:.85rem;color:var(--muted)}
  .entry{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px;margin-top:10px}
  .entry h3{margin:.2rem 0;font-size:1rem}
  .badges{margin:4px 0;font-size:.9rem;color:#333;word-break:break-word}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{flex:1}
  .danger{background:#ffe8e8;color:#842029}
  .link-btn{display:inline-block;text-decoration:none;padding:8px 12px;border:1px solid var(--border);border-radius:10px}
  .hide{display:none}
  .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-inline-end:6px;background:#bbb}
  .status-ok{background:#29a745}
  .status-bad{background:#d33}
  .summary-actions{margin-top:12px;display:flex;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <h1 id="title">××¢×§×‘ × ×’×¢×™ ×¢×•×¨ â€“ ABCDE</h1>

  <div class="right">
    <select id="langSwitcher" aria-label="Language">
      <option value="he">×¢×‘×¨×™×ª</option>
      <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
    </select>

    <button id="btnAnonSignIn" class="secondary">×›× ×™×¡×” ×× ×•× ×™××™×ª</button>
    <button id="btnSignOut" class="secondary hide">×”×ª× ×ª×§×•×ª</button>

    <span class="tiny" id="authState"><span class="status-dot"></span> ××¦×‘: ×× ×•×ª×§</span>
  </div>
</header>

<main>
  <section class="card">
    <p class="tiny" id="note">×”××™×“×¢ × ×©××¨ ×‘×—×©×‘×•×Ÿ Supabase ×©×œ×š (×¢× ×›× ×™×¡×” ×× ×•× ×™××™×ª). ×”×ª××•× ×•×ª × ×©××¨×•×ª ×‘××—×¡×•×Ÿ ×”×¢× ×Ÿ ×©×œ×š.</p>

    <form id="entryForm">
      <label for="date" id="lblDate">×ª××¨×™×š</label>
      <input id="date" name="date" type="date" required>

      <label for="title" id="lblTitle">×›×•×ª×¨×ª ×§×¦×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
      <input id="title" name="title" type="text" placeholder="×œ××©×œ: ×ª×™×¢×•×“ ×¨××©×•×Ÿ">

      <label for="notes" id="lblNotes">×ª×™××•×¨/×ª×¡××™× ×™×</label>
      <textarea id="notes" name="notes" placeholder="×©×™× ×•×™×™×, ×›××‘/×’×¨×“, ×“×™××•×, ××™×§×•×..."></textarea>

      <label for="photo" id="lblPhoto">×ª××•× ×” (××•××œ×¥)</label>
      <input id="photo" name="photo" type="file" accept="image/*">

      <div id="abcdeSection"></div>

      <div id="changesWrap" class="hide">
        <label for="changesText" id="lblChangesText">×¤×¨×˜×™ ×”×©×™× ×•×™×™×</label>
        <textarea id="changesText" name="changesText" placeholder="××” ×”×©×ª× ×”? ×’×•×“×œ, ×¦×‘×¢, ×¦×•×¨×”, ×“×™××•×..."></textarea>
      </div>

      <div class="actions">
        <button type="submit" class="primary" id="btnAdd">×”×•×¡×£/×™ ×ª×™×¢×•×“</button>
        <button type="button" class="secondary" id="clearBtn">××™×¤×•×¡ ×”×›×œ (×©×¨×ª)</button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2 id="myRecords">×”×¨×©×•××•×ª ×©×œ×™</h2>
    <div id="list"></div>

    <!-- ×›×¤×ª×•×¨ ×”×¡×™×›×•× ××ª×—×ª ×œ×¨×©×•××•×ª -->
    <div class="summary-actions">
      <button type="button" class="secondary" id="summaryBtn">×¤×ª×—/×™ ×“×£ ×¡×™×›×•×</button>
    </div>
  </section>
</main>

<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ================= Supabase config (client-side) =================
   IMPORTANT: Use ONLY the anon key here. Do NOT expose the service_role key. */
const SUPABASE_URL = "https://gcjfkgrohlitqzktgqvd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjamZrZ3JvaGxpdHF6a3RncXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NjA2ODEsImV4cCI6MjA3MzQzNjY4MX0.aWha5IHE6lttKC3h8qa3JvKf6uH9OZwAIs_EESNoZig";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});
let currentUser = null;

/* ================= i18n ================= */
const translations = {
  he:{ title:"××¢×§×‘ × ×’×¢×™ ×¢×•×¨ â€“ ABCDE",
    note:"×”××™×“×¢ × ×©××¨ ×‘×—×©×‘×•×Ÿ Supabase ×©×œ×š (×¢× ×›× ×™×¡×” ×× ×•× ×™××™×ª). ×”×ª××•× ×•×ª × ×©××¨×•×ª ×‘××—×¡×•×Ÿ ×”×¢× ×Ÿ ×©×œ×š.",
    lblDate:"×ª××¨×™×š", lblTitle:"×›×•×ª×¨×ª ×§×¦×¨×” (××•×¤×¦×™×•× ×œ×™)", lblNotes:"×ª×™××•×¨/×ª×¡××™× ×™×", lblPhoto:"×ª××•× ×” (××•××œ×¥)",
    lblChangesText:"×¤×¨×˜×™ ×”×©×™× ×•×™×™×", btnAdd:"×”×•×¡×£/×™ ×ª×™×¢×•×“", btnClear:"××™×¤×•×¡ ×”×›×œ (×©×¨×ª)",
    myRecords:"×”×¨×©×•××•×ª ×©×œ×™", openImage:"ğŸ“· ×¤×ª×— ×ª××•× ×”", delete:"××—×™×§×”", confirmDelete:"×œ××—×•×§ ××ª ×”×¨×©×•××”?",
    confirmDeleteAll:"×œ××—×•×§ ××ª ×›×œ ×”×¨×©×•××•×ª ××”×©×¨×ª?", noRecords:"××™×Ÿ ×¨×©×•××•×ª.",
    authUi:{ signin:"×›× ×™×¡×” ×× ×•× ×™××™×ª", signout:"×”×ª× ×ª×§×•×ª", connecting:"××ª×—×‘×¨...", ready:"××—×•×‘×¨ (×× ×•× ×™××™)", off:"×× ×•×ª×§" },
    abcde:{ A:["××¡×™××˜×¨×™×”","×¡×™××˜×¨×™","×œ× ×¡×™××˜×¨×™"], B:["×’×‘×•×œ","×’×‘×•×œ×•×ª ×‘×¨×•×¨×™×","×’×‘×•×œ ×œ× ××—×™×“/××©×•× ×Ÿ"],
            C:["×¦×‘×¢","×¦×‘×¢ ××—×™×“","××¡×¤×¨ ×¦×‘×¢×™×"], D:["×§×•×˜×¨","×§×˜×Ÿ ×-6 ×\"×","×’×“×•×œ ×-6 ×\"×"], E:["×©×™× ×•×™/×”×ª×¤×ª×—×•×ª","×œ×œ× ×©×™× ×•×™","×™×© ×©×™× ×•×™"] },
    labels:{ date:"×ª××¨×™×š", title:"×›×•×ª×¨×ª", notes:"×ª×™××•×¨/×ª×¡××™× ×™×", abcde:"×¡×™×›×•× ABCDE", changes:"×¤×¨×˜×™ ×”×©×™× ×•×™×™×", image:"×ª××•× ×”" },
    summaryBtn:"×¤×ª×—/×™ ×“×£ ×¡×™×›×•×", summaryTitle:"×¡×™×›×•× ×¨×©×•××•×ª", summaryNoData:"××™×Ÿ ×¨×©×•××•×ª ×œ×”×¦×’×”."
  },
  ru:{ title:"ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ ĞºĞ¾Ğ¶Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ â€“ ABCDE",
    note:"Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Supabase (Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´). Ğ¤Ğ¾Ñ‚Ğ¾ Ğ² Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ğ¾Ğ¼ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ.",
    lblDate:"Ğ”Ğ°Ñ‚Ğ°", lblTitle:"ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)", lblNotes:"ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ/ÑĞ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹", lblPhoto:"Ğ¤Ğ¾Ñ‚Ğ¾ (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)",
    lblChangesText:"ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹", btnAdd:"Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ", btnClear:"ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ (ÑĞµÑ€Ğ²ĞµÑ€)",
    myRecords:"ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸", openImage:"ğŸ“· ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾", delete:"Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", confirmDelete:"Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ?",
    confirmDeleteAll:"Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ?", noRecords:"Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½ĞµÑ‚.",
    authUi:{ signin:"ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´", signout:"Ğ’Ñ‹Ğ¹Ñ‚Ğ¸", connecting:"ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµâ€¦", ready:"ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ (Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ğ¾)", off:"ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾" },
    abcde:{ A:["ĞÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ","Ğ¡Ğ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡Ğ½Ğ¾Ğµ","ĞÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡Ğ½Ğ¾Ğµ"], B:["Ğ“Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°","Ğ§Ñ‘Ñ‚ĞºĞ°Ñ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°","ĞĞµÑ‡Ñ‘Ñ‚ĞºĞ°Ñ/Ğ½ĞµÑ€Ğ¾Ğ²Ğ½Ğ°Ñ"],
            C:["Ğ¦Ğ²ĞµÑ‚","ĞĞ´Ğ¸Ğ½ Ñ†Ğ²ĞµÑ‚","ĞĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ²"], D:["Ğ”Ğ¸Ğ°Ğ¼ĞµÑ‚Ñ€","ĞœĞµĞ½ÑŒÑˆĞµ 6 Ğ¼Ğ¼","Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ 6 Ğ¼Ğ¼"], E:["Ğ­Ğ²Ğ¾Ğ»ÑÑ†Ğ¸Ñ","Ğ‘ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹","Ğ•ÑÑ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ"] },
    labels:{ date:"Ğ”Ğ°Ñ‚Ğ°", title:"Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº", notes:"ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ/ÑĞ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹", abcde:"Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° ABCDE", changes:"ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹", image:"Ğ¤Ğ¾Ñ‚Ğ¾" },
    summaryBtn:"ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑĞ²Ğ¾Ğ´Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ", summaryTitle:"Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹", summaryNoData:"ĞĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ."
  }
};
function currentLang(){ return document.getElementById("langSwitcher").value || "he"; }
function t(){ return translations[currentLang()]; }
function escapeHtml(s){return String(s||"").replace(/[&<>"]/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]))}

/* ================= ABCDE UI ================= */
function isChangeValue(v){ return v && (v === "×™×© ×©×™× ×•×™" || v === "Ğ•ÑÑ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ"); }
function buildABCDE(lang){
  const tr = translations[lang]; const sec = document.getElementById("abcdeSection"); sec.innerHTML="";
  for(const k of ["A","B","C","D","E"]){
    const [title,opt1,opt2]=tr.abcde[k];
    const fs=document.createElement("fieldset"); fs.className="abcde-item";
    fs.innerHTML = `<legend>${k} â€“ ${title}</legend>
      <div class="abcde-options">
        <label><input type="radio" name="${k}" value="${opt1}" required> ${opt1}</label>
        <label><input type="radio" name="${k}" value="${opt2}"> ${opt2}</label>
      </div>`;
    sec.appendChild(fs);
  }
}
function summarizeABCDE(entry){
  const src = entry.abcde || entry.ABCDE || {};
  return ["A","B","C","D","E"].map(k=>k+": "+(src[k]||"?")).join(" | ");
}
function toggleChangesBox(show){ document.getElementById("changesWrap").classList.toggle("hide", !show); }
document.addEventListener("change",(e)=>{ if(e.target && e.target.name==="E"){ toggleChangesBox(isChangeValue(e.target.value)); }});

/* ================= Auth (Anonymous) ================= */
async function updateAuthUi(state, info=""){
  const el = document.getElementById("authState");
  const btnIn = document.getElementById("btnAnonSignIn");
  const btnOut = document.getElementById("btnSignOut");
  if(state==="on"){
    el.innerHTML = `<span class="status-dot status-ok"></span> ${t().authUi.ready} â€¢ ${info}`;
    btnIn.classList.add("hide"); btnOut.classList.remove("hide");
  }else if(state==="connecting"){
    el.innerHTML = `<span class="status-dot"></span> ${t().authUi.connecting}`;
    btnIn.classList.remove("hide"); btnOut.classList.add("hide");
  }else{
    el.innerHTML = `<span class="status-dot"></span> ${t().authUi.off}`;
    btnIn.classList.remove("hide"); btnOut.classList.add("hide");
  }
}
async function signInAnon(){
  await updateAuthUi("connecting");
  const { data, error } = await supabase.auth.signInAnonymously();
  if(error){ await updateAuthUi("off"); alert("Auth error"); return; }
  currentUser = data.session.user;
  await updateAuthUi("on", currentUser.id.slice(0,8));
  await renderList();
}
async function loadSession(){
  await updateAuthUi("connecting");
  const { data:{ session } } = await supabase.auth.getSession();
  if(session){ currentUser = session.user; await updateAuthUi("on", currentUser.id.slice(0,8)); }
  else { currentUser = null; await updateAuthUi("off"); }
}
document.getElementById("btnAnonSignIn").addEventListener("click", signInAnon);
document.getElementById("btnSignOut").addEventListener("click", async ()=>{
  await supabase.auth.signOut(); currentUser=null; await updateAuthUi("off"); document.getElementById("list").innerHTML="";
});

/* ================= Storage upload ================= */
async function uploadImageIfAny(file, entryId){
  if(!file) return {path:null, url:null};
  const ext = (file.type.split("/")[1]||"jpg").toLowerCase();
  const path = `${currentUser.id}/${entryId}-${Date.now()}.${ext}`;
  const { error } = await supabase.storage.from("lesion-photos").upload(path, file, { upsert:false, contentType:file.type });
  if(error){ console.warn("storage upload error", error); return {path:null, url:null}; }
  const { data:pub } = supabase.storage.from("lesion-photos").getPublicUrl(path);
  return { path, url: pub.publicUrl };
}

/* ================= DB ops ================= */
async function fetchEntries(){
  if(!currentUser) return [];
  const { data, error } = await supabase.from("entries").select("*").order("date",{ascending:true}).order("created_at",{ascending:true});
  if(error){ console.error(error); return []; }
  return data || [];
}
async function insertEntry(e){
  const { data, error } = await supabase.from("entries").insert(e).select().single();
  if(error){ console.error(error); return null; }
  return data;
}
async function deleteEntryServer(id, image_path){
  const { error } = await supabase.from("entries").delete().eq("id", id);
  if(error){ alert("Delete failed"); return; }
  if(image_path){ await supabase.storage.from("lesion-photos").remove([image_path]).catch(()=>{}); }
}

/* ================= List render ================= */
async function renderList(){
  const tr = t(); const list=document.getElementById("list");
  const btnSummary = document.getElementById("summaryBtn");
  if(!currentUser){ 
    list.innerHTML = `<p class="tiny">${tr.authUi.off} â€“ ${tr.authUi.signin || 'Sign in'}</p>`;
    btnSummary.disabled = true;
    return; 
  }
  const entries = await fetchEntries();
  list.innerHTML = "";
  if(entries.length===0){ 
    list.innerHTML = `<p class="tiny">${tr.noRecords}</p>`;
    btnSummary.disabled = true;
    return; 
  }
  btnSummary.disabled = false;

  for(const e of entries){
    const div=document.createElement("div"); div.className="entry"; div.dataset.id=e.id; if(e.image_path) div.dataset.path=e.image_path;
    const titleLine = [e.date || "", e.title || ""].filter(Boolean).join(" â€“ ");
    div.innerHTML = `
      <h3>${escapeHtml(titleLine)}</h3>
      <div class="badges">${escapeHtml(summarizeABCDE(e))}</div>
      ${e.notes ? `<p>${t().labels.notes}: ${escapeHtml(e.notes)}</p>` : ""}
      ${e.changes_text ? `<p>${t().labels.changes}: ${escapeHtml(e.changes_text)}</p>` : ""}
      <div class="row">
        ${e.image_url ? `<a class="link-btn" href="${e.image_url}" target="_blank" rel="noopener">${t().openImage}</a>` : ""}
        <div class="spacer"></div>
        <button type="button" class="danger delete-btn">${t().delete}</button>
      </div>`;
    list.appendChild(div);
  }
}
document.getElementById("list").addEventListener("click", async (ev)=>{
  const btn = ev.target.closest(".delete-btn"); if(!btn) return;
  const card = ev.target.closest(".entry"); if(!card) return;
  if(confirm(t().confirmDelete)){ await deleteEntryServer(card.dataset.id, card.dataset.path || null); renderList(); }
});

/* ================= Form submit ================= */
document.getElementById("entryForm").addEventListener("submit", async (ev)=>{
  ev.preventDefault();
  if(!currentUser){ await signInAnon(); if(!currentUser) return; }

  const f = ev.currentTarget;
  const date = f.date.value || new Date().toISOString().slice(0,10);
  const title = f.title.value.trim();
  const notes = f.notes.value.trim();
  const ABCDE = {};
  ["A","B","C","D","E"].forEach(k=>{
    const v = f.querySelector(`input[name="${k}"]:checked`);
    if(v) ABCDE[k] = v.value;
  });
  let changes_text = "";
  if(isChangeValue(ABCDE.E)){ changes_text = (document.getElementById("changesText").value || "").trim(); }

  // upload image (if any)
  let imgPath=null, imgUrl=null;
  const file = f.photo.files && f.photo.files[0] ? f.photo.files[0] : null;
  const tempId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());
  if(file){
    const up = await uploadImageIfAny(file, tempId);
    imgPath = up.path; imgUrl = up.url;
  }

  const payload = {
    id: tempId,
    user_id: currentUser.id,
    date,
    title,
    notes,
    abcde: ABCDE,
    changes_text,
    image_path: imgPath,
    image_url: imgUrl
  };

  const saved = await insertEntry(payload);
  if(saved){
    f.reset(); buildABCDE(currentLang()); toggleChangesBox(false);
    document.getElementById("date").value = new Date().toISOString().slice(0,10);
    renderList();
  }else{
    alert("×©××™×¨×” × ×›×©×œ×”");
  }
});

/* ================= Summary page (opens new tab) ================= */
document.getElementById("summaryBtn").addEventListener("click", async (ev)=>{
  // 1) Open a window/tab *synchronously* to bypass mobile popup blockers
  const w = window.open('', '_blank');
  if(!w){
    alert('Please allow pop-ups to view the summary page.');
    return;
  }
  // Light "loading" skeleton so users see something immediately
  w.document.open();
  w.document.write(`<!doctype html><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Loadingâ€¦</title><style>body{font-family:system-ui;margin:24px}</style><p>×˜×•×¢×Ÿ/×ª ××ª ×”×¡×™×›×•×â€¦</p>`);
  w.document.close();

  // 2) Now do async work
  if(!currentUser){ await signInAnon(); if(!currentUser){ w.close(); return; } }
  const tr = t(), L = tr.labels;
  const entries = await fetchEntries();
  if(!entries.length){
    w.document.open(); w.document.write(`<p style="font-family:system-ui;margin:24px">${tr.summaryNoData}</p>`); w.document.close();
    return;
  }

  const dir = document.documentElement.dir || "rtl";
  const lang = document.documentElement.lang || "he";
  const returnUrl = location.href;
  const safe = (s)=>escapeHtml(s);

  // 3) Build the full summary HTML
  let html = `<!DOCTYPE html><html lang="${lang}" dir="${dir}">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>${safe(tr.summaryTitle)}</title>
<style>
  :root{ --fg:#111; --muted:#666; --border:#e6e8eb; --card:#fafbfc; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;color:var(--fg)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;align-items:center;z-index:5}
  h1{font-size:1.1rem;margin:0}
  main{padding:16px;max-width:900px;margin:auto}
  .entry{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0}
  .entry h2{margin:.2rem 0;font-size:1rem}
  .row{margin:.25rem 0}
  .lbl{font-weight:600;color:#222}
  .abcde{font-family:ui-monospace,Consolas,monospace;padding:.25rem .5rem;background:#fff;border:1px solid var(--border);border-radius:8px;display:inline-block}
  img{max-width:45%;height:auto;display:block;margin:.5rem 0;border:1px solid var(--border);border-radius:10px}
  .top-actions{margin-inline-start:auto;display:flex;gap:8px}
  .btn{padding:8px 12px;border:1px solid var(--border);background:#f5f7fb;border-radius:8px;cursor:pointer;text-decoration:none;color:inherit;display:inline-block}
</style>
</head><body>
<header>
  <h1>${safe(tr.summaryTitle)}</h1>
  <div class="top-actions">
    <button class="btn" onclick="window.print()">${dir==='rtl'?'×”×“×¤×¡×”/×©×™×ª×•×£':'Print/Share'}</button>
    <a class="btn" href="${safe(returnUrl)}">${dir==='rtl'?'×—×–×¨×” ×œ××¤×œ×™×§×¦×™×”':'Back to app'}</a>
  </div>
</header>
<main>`;

  for(const e of entries){
    const titleLine = [e.date || "", e.title || ""].filter(Boolean).join(" â€“ ");
    const abcde = summarizeABCDE({ abcde: e.abcde });
    html += `<article class="entry">
      <h2>${safe(titleLine)}</h2>
      <div class="row"><span class="lbl">${safe(L.date)}:</span> ${safe(e.date||"")}</div>
      ${e.title ? `<div class="row"><span class="lbl">${safe(L.title)}:</span> ${safe(e.title)}</div>` : ""}
      ${e.notes ? `<div class="row"><span class="lbl">${safe(L.notes)}:</span> ${safe(e.notes)}</div>` : ""}
      <div class="row"><span class="lbl">${safe(L.abcde)}:</span> <span class="abcde">${safe(abcde)}</span></div>
      ${e.changes_text ? `<div class="row"><span class="lbl">${safe(L.changes)}:</span> ${safe(e.changes_text)}</div>` : ""}
      ${e.image_url ? `<img src="${e.image_url}" alt="photo">` : ""}
    </article>`;
  }
  html += `</main></body></html>`;

  // 4) Replace the provisional tab's contents.
  // Write directly (works well after the tab is already user-opened).
  w.document.open();
  w.document.write(html);
  w.document.close();
});

/* ================= Language + init ================= */
function applyLanguage(lang){
  const tr = translations[lang];
  document.documentElement.lang = (lang==="he") ? "he" : "ru";
  document.documentElement.dir  = (lang==="he") ? "rtl" : "ltr";
  document.getElementById("title").textContent = tr.title;
  document.getElementById("note").textContent  = tr.note;
  document.getElementById("lblDate").textContent  = tr.lblDate;
  document.getElementById("lblTitle").textContent = tr.lblTitle;
  document.getElementById("lblNotes").textContent = tr.lblNotes;
  document.getElementById("lblPhoto").textContent = tr.lblPhoto;
  document.getElementById("lblChangesText").textContent = tr.lblChangesText;
  document.getElementById("btnAdd").textContent   = tr.btnAdd;
  document.getElementById("clearBtn").textContent = tr.btnClear;
  document.getElementById("myRecords").textContent= tr.myRecords;
  document.getElementById("btnAnonSignIn").textContent = tr.authUi.signin;
  document.getElementById("btnSignOut").textContent    = tr.authUi.signout;
  document.getElementById("summaryBtn").textContent    = tr.summaryBtn;

  // rebuild ABCDE keeping selections
  const sel = {}; ["A","B","C","D","E"].forEach(k=>{
    const checked = document.querySelector(`#entryForm input[name="${k}"]:checked`);
    if(checked) sel[k]=checked.value;
  });
  buildABCDE(lang);
  ["A","B","C","D","E"].forEach(k=>{
    if(sel[k]){
      const el = Array.from(document.querySelectorAll(`#entryForm input[name="${k}"]`)).find(r=>r.value===sel[k]);
      if(el) el.checked = true;
    }
  });
}

document.getElementById("langSwitcher").addEventListener("change", e=> applyLanguage(e.target.value));

(async function init(){
  applyLanguage("he"); // default; user can switch
  document.getElementById("date").value = new Date().toISOString().slice(0,10);
  await loadSession();
  await renderList();
})();
</script>
</body>
</html>
